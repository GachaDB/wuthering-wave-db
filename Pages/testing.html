<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gacha System</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 20px;
		}

		.navbar {
			margin-bottom: 20px;
		}

		.navbar button {
			padding: 10px;
			font-size: 16px;
			margin-right: 10px;
			cursor: pointer;
		}

		.banner {
			display: none;
			margin-bottom: 20px;
		}

		.summon-buttons {
			margin-bottom: 20px;
		}
		/* Grid Layout for Summoning Results */
		.summoning-result {
	display: grid;
	grid-template-columns: repeat(5, 1fr); /* Exactly 5 items per row */
	gap: 20px;
	justify-items: center; /* Centers each item in its grid cell horizontally */
	align-items: center; /* Centers each item in its grid cell vertically */
	margin-top: 20px;
	width: 80%; /* Set width of the summoning result container */
	max-width: 1200px; /* Optional: Set max width to prevent container from growing too wide */
	margin-left: auto; /* Center the container horizontally */
	margin-right: auto; /* Center the container horizontally */
}


		.history {
			margin-top: 20px;
		}

		.history ul {
			max-height: 200px;
			overflow-y: auto;
			border: 1px solid #ccc;
			padding: 10px;
			list-style-type: none;
		}

		.result {
			border: 2px solid gold;
			padding: 10px;
			margin-top: 20px;
			display: none;
			font-weight: bold;
			color: gold;
		}
		.summon-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 200px;
    height: 250px;
    border-radius: 10px;
    text-align: center;
    font-weight: bold;
    transition: transform 0.2s ease-in-out;
}

/* Default styling for all summon images */
.summon-item img {
    width: 100%;
    height: 100%;
    border-radius: 5px;
}

/* Weapons: Full cover */
.summon-item-weapon img {
    object-fit: cover;
    width: 150px; /* Adjust based on actual image size */
    height: 150px;
}

/* Resonators: Cropped Image */
.summon-item-resonator img {
    width: 120px; /* Adjust width */
    height: 120px; /* Adjust height */
    object-fit: cover;
    clip-path: inset(10% 15% 40% 15%); /* Crop top 10%, sides 15%, bottom 40% */
    border-radius: 10px;
}


.summon-item:hover {
    transform: scale(1.1);
}

/* Image styling */
.summon-item img {
    width: 100%;  /* Adjust size */
    height: 100%; /* Adjust size */
    object-fit: contain;
    border-radius: 5px;
}

/* Rarity colors */
.rarity-3 {
    background: #6C757D; /* Gray */
    border: 3px solid #ADB5BD;
    color: white;
}

.rarity-4 {
    background: #7D5BB1; /* Purple */
    border: 3px solid #A377E8;
    color: white;
}

.rarity-5 {
    background: #E4AF24; /* Gold */
    border: 3px solid #FFD700;
    color: black;
}

	</style>
</head>

<body>
	<h1>Gacha System</h1>
	<div class="navbar">
		<button onclick="showPage('hero')">Hero Banner</button>
		<button onclick="showPage('weapon')">Weapon Banner</button>
	</div>
	
	<!-- Summon Result Notification -->
	<div id="summonResult" class="result"></div>
	
	<label style="opacity: 0;">
        <input type="checkbox" id="limitedToggle">
        Include Limited Items
    </label>

	<!-- Hero Banner Page -->
	<div id="heroBanner" class="banner">
		<h2>Hero Banner</h2>
		<p>Pity Count: <span id="heroPity">0</span> / 80</p>
		<div class="summon-buttons">
			<button onclick="summon('hero', 1)">Summon 1x</button>
			<button onclick="summon('hero', 10)">Summon 10x</button>
		</div>
		<div id="summoningResult" class="summoning-result">
			<!-- Summon result will be shown here -->
		</div>

		<div class="history">
			<h3>Hero Summon History</h3>
			<button onclick="clearHistory('hero')">Clear Hero History</button>
			<ul id="heroHistoryList"></ul>
		</div>
	</div>

	<!-- Weapon Banner Page -->
	<div id="weaponBanner" class="banner">
		<h2>Weapon Banner</h2>
		<p>Pity Count: <span id="weaponPity">0</span> / 80</p>
		<div class="summon-buttons">
			<button onclick="summon('weapon', 1)">Summon 1x</button>
			<button onclick="summon('weapon', 10)">Summon 10x</button>
		</div>
		<div id="summoningResult" class="summoning-result">
			<!-- Summon result will be shown here -->
		</div>
		<div class="history">
			<h3>Weapon Summon History</h3>
			<button onclick="clearHistory('weapon')">Clear Weapon History</button>
			<ul id="weaponHistoryList"></ul>
		</div>
	</div>


	<script>
		const poolDataUrl = 'https://raw.githubusercontent.com/GachaDB/wuthering-wave-db/refs/heads/main/Asset/Json/pool.json';
		const rates = {
			base5Star: 0.008,
			average5Star: 0.018,
			guarantee5Star: 80,
			base4Star: 0.06,
			guarantee4Star: 10,
			increased5StarPerSummon: 0.05,
			softPity: 67
		};
		const featuredItems = {
			hero: "Jinhsi",
			weapon: "Ages of Harvest",
			fourStarHero: ["Baizhi", "Danjin", "Yuanwu"],
			fourStarWeapon: ["Discord", "Overture", "Variation"]
		};
		let summonData = JSON.parse(localStorage.getItem('summonData')) || {
			hero: {
				pity: 0,
				lost50_50: false,
				history: []
			},
			weapon: {
				pity: 0,
				lost50_50: false,
				history: []
			}
		};
	
		function showPage(page) {
				// Hide both pages initially
				document.getElementById('heroBanner').style.display = 'none';
				document.getElementById('weaponBanner').style.display = 'none';
				
				// Show the selected page
				if (page === 'hero') {
					document.getElementById('heroBanner').style.display = 'block';
				} else if (page === 'weapon') {
					document.getElementById('weaponBanner').style.display = 'block';
				}
			}
	
			// Default to Hero Banner page on load
			showPage('hero');
	
		async function fetchPoolData() {
			const response = await fetch(poolDataUrl);
			return response.json();
		}
	
		function filterPoolData(data, type, includeLimited) {
			return data.filter(item => ((type === "hero" && item.type === "resonator") || (type === "weapon" && item.type === "weapon") || item.type === "any") && (includeLimited || !item.limited));
		}
	
		function getRandomItem(pool, rarity) {
			const filteredPool = pool.filter(item => item.rarity === rarity);
			if(filteredPool.length === 0) {
				// console.error(`No items found for rarity ${rarity}`);
				return {
					name: `Unknown ${rarity}★`,
					rarity
				}; // Fallback item
			}
			return { ...filteredPool[Math.floor(Math.random() * filteredPool.length)] }; 
		}
	
		async function summon(bannerType, count) {
		const includeLimited = document.getElementById('limitedToggle').checked;
		const poolData = await fetchPoolData();
		const pool = filterPoolData(poolData, bannerType, includeLimited);
		const results = [];
		const summonResults = [];
	
		for (let i = 0; i < count; i++) {
			summonData[bannerType].pity++;
			let pityCount = summonData[bannerType].pity;
			let rarity;
	
			// Base 5★ rate calculation
			let fiveStarRate = rates.base5Star;
			if (pityCount > rates.softPity) {
				fiveStarRate += (pityCount - rates.softPity) * rates.increased5StarPerSummon;
			}
			fiveStarRate = Math.min(fiveStarRate, 1); // Ensure max is 100%
	
			// Determine rarity
			const random = Math.random();
			if (pityCount >= rates.guarantee5Star) {
				rarity = 5; // Guaranteed 5★
			} else if (pityCount % rates.guarantee4Star === 0) {
				rarity = 4; // Guaranteed 4★ every 10 summons
			} else {
				if (random < fiveStarRate) {
					rarity = 5;
				} else if (random < fiveStarRate + rates.base4Star) {
					rarity = 4;
				} else {
					rarity = 3;
				}
			}
	
			// Get item
			let item;
			// do {
				if (rarity === 5 && bannerType === "weapon") {
					item = { name: featuredItems.weapon, rarity: 5 }; // Always give featured weapon
				} else {
					item = getRandomItem(pool, rarity);
				}
			// } while (!isValidItem(item));
	
			if (!item) {
				// console.error("[ERROR] No item found for rarity", rarity);
				continue;
			}
	
			// [Debug] Check item before mutation
			// console.log("[Debug] Initial item:", JSON.stringify(item));
			// console.log("[Debug] Type of item.name:", typeof item.name);
	
			// console.log("[Debug] Final item before storing:", JSON.stringify(item));
	
			// Apply banner rules
			if (rarity === 5) {
				if (bannerType === "hero") {
					console.log("[Debug] Before check50_50System:", JSON.stringify(item));
					check50_50System(bannerType, item);
					console.log("[Debug] After check50_50System:", JSON.stringify(item));
				} else if (bannerType === "weapon") {
					item.isFeatured = true; // Weapons are always featured
				}
				showSummonResult(item, bannerType, summonData[bannerType].pity);
				summonData[bannerType].pity = 0; // Reset pity AFTER rolling 5★
			} else if (rarity === 4) {
				// console.log("[Debug] Before check4Star50_50System:", JSON.stringify(item));
				check4Star50_50System(bannerType, item, pool);
				// console.log("[Debug] After check4Star50_50System:", JSON.stringify(item));
			}
	
			// [Debug] Log before storing
			// console.log("[Debug] [FINAL DEBUG] Item before pushing:", JSON.stringify(item));
	
			// Deep clone item to prevent mutations
			let fixedItem = JSON.parse(JSON.stringify(item));
	
			// Store results
			results.push(fixedItem);
			summonResults.push(fixedItem);
			saveToHistory(bannerType, fixedItem);
		}
	
		// Update UI & history
		showLatestSummonResult(summonResults);
		updateHistoryDisplay(bannerType);
		updatePityCounter(bannerType);
		localStorage.setItem("summonData", JSON.stringify(summonData));
	}
	
	function isValidItem(item) {
		// console.log("[Debug] Checking item validity:", JSON.stringify(item, null, 2)); // Full snapshot
	
		// Extract the raw name if item.name is an object
		let rawItemName = typeof item.name === "object" && item.name !== null ? item.name.name : item.name;
		
		// console.log("[Debug] Extracted raw item name:", rawItemName);
		// console.log("[Debug] Type of extracted raw item name:", typeof rawItemName);
	
		if (typeof rawItemName !== "string") { 
			// console.warn("❌ Invalid item: name is not a string", rawItemName);
			return false;
		}
	
		// console.log("[Debug] pre changed item name:", item.name);
		// Modify item to store the correct name
		item.name = rawItemName;
		// console.log("[Debug] post changed item name:", item.name);
	
		// console.log("[Debug] ✅ Item is valid:", JSON.stringify(item, null, 2));
		return true;
	}
	
	function saveToHistory(bannerType, item) {
		summonData[bannerType].history.push({
			name: item.name,
			rarity: item.rarity, // Ensure rarity is stored
			time: new Date().toLocaleString()
		});
	}
	
	function getFeaturedWeapon(pool) {
		return pool.find(item => item.rarity === 5 && item.isFeatured);
	}
	
	function updateHistoryDisplay(bannerType) {
		const historyList = document.getElementById(`${bannerType}HistoryList`);
		historyList.innerHTML = '';
		summonData[bannerType].history.forEach(entry => {
			const listItem = document.createElement('li');
			listItem.textContent = `${entry.name} at ${entry.time}`;
			// Apply color based on rarity
			if(entry.rarity === 5) {
				listItem.style.color = 'gold';
			} else if(entry.rarity === 4) {
				listItem.style.color = 'purple';
			} else {
				listItem.style.color = 'blue';
			}
			historyList.appendChild(listItem);
		});
	}
	
	function updatePityCounter(bannerType) {
		document.getElementById(`${bannerType}Pity`).textContent = summonData[bannerType].pity;
	}
	
	function check50_50System(bannerType, item) {
		// Ensure summonData is initialized
		if(!summonData) summonData = {}; 
		
		// Initialize summonData for the bannerType if not already present
		if(!summonData[bannerType]) {
			summonData[bannerType] = {
				lost50_50: false,
				lost50_50Count: 0,
				total5Stars: 0
			};
		}
		
		summonData[bannerType].total5Stars++; // Increment total 5-star count
	
		// console.log(`[Debug] Checking 50/50 System for bannerType: ${bannerType}`);
		// console.log(`[Debug] Total 5-Stars so far: ${summonData[bannerType].total5Stars}`);
		// console.log(`[Debug] Lost 50/50 count: ${summonData[bannerType].lost50_50Count}`);
		
		// Guarantee featured if last 50/50 was lost
		if(summonData[bannerType].lost50_50) {
			// console.log("[Debug] Last 50/50 was lost, forcing featured item.");
			item.name = featuredItems[bannerType];
            item.image = `${item.name}_Head_Icon.webp`;
            item.video = `${item.name}_Summon_Animation.mp4`;
            item.limited = true;
			summonData[bannerType].lost50_50 = false; // Reset loss flag
		} else {
			// 50% chance to get featured, 50% chance to lose
			if(Math.random() < 0.5) {
				// console.log("[Debug] Won the 50/50, getting featured item.");
				item.name = featuredItems[bannerType]; // Win 50% of the time
				item.image = `${item.name}_Head_Icon.webp`;
				item.video = `${item.name}_Summon_Animation.mp4`;
				item.limited = true;
				summonData[bannerType].lost50_50 = false; // Reset loss flag
			} else {
				// console.log("[Debug] Lost the 50/50, not getting featured item.");
				summonData[bannerType].lost50_50 = true; // Lose 50% of the time
				summonData[bannerType].lost50_50Count++; // Increment lost 50/50 counter
			}
		}
	
		// [Debug] Logs for lost50_50Count after update
		// console.log(`[Debug] Updated Lost 50/50 count: ${summonData[bannerType].lost50_50Count}`);
	}
	
	function check4Star50_50System(bannerType, item, pool) {
		if(!summonData) summonData = {}; // Ensure summonData is initialized
		if(!summonData[bannerType]) summonData[bannerType] = {
			lost50_50_4: false,
			lost50_50Count_4: 0,
			total4Stars: 0
		};
		summonData[bannerType].total4Stars++; // Track total 4★ obtained
		// Define featured and standard pools
		let featuredPool = bannerType === "hero" ? featuredItems.fourStarHero : featuredItems.fourStarWeapon;
		let standardPool = pool.filter(i => !featuredPool.includes(i.name) && i.rarity === 4); // Use the provided pool
		// Guarantee featured if last 50/50 was lost
		if(summonData[bannerType].lost50_50_4) {
			item = featuredPool[Math.floor(Math.random() * featuredPool.length)];
			summonData[bannerType].lost50_50_4 = false; // Reset loss flag
		} else {
			// 50% chance to get featured, 50% chance to lose
			if(Math.random() < 0.5) {
				item = featuredPool[Math.floor(Math.random() * featuredPool.length)]; // Win 50/50
				summonData[bannerType].lost50_50_4 = false;
			} else {
				item = standardPool[Math.floor(Math.random() * standardPool.length)]; // Lose 50/50
				summonData[bannerType].lost50_50_4 = true;
				summonData[bannerType].lost50_50Count_4++;
			}
		}
		// [Debug] Output
		// console.log(`[Debug] Banner: ${bannerType} (4★)`);
		// console.log(`[Debug] Total 4★ Obtained: ${summonData[bannerType].total4Stars}`);
		// console.log(`[Debug] Lost 50/50 Count (4★): ${summonData[bannerType].lost50_50Count_4}`);
		// console.log(`[Debug] Current Lost 50/50 Status (4★): ${summonData[bannerType].lost50_50_4}`);
	}
	
	function showLatestSummonResult(items) {
    // Get the div where the summoning result will be shown
    const resultDiv = document.getElementById('summoningResult');
    
    // Clear any previous summon results
    resultDiv.innerHTML = '';

    // Loop through the items (could be 1 or more)
    items.forEach(item => {
        const resultContent = document.createElement('div');
        resultContent.classList.add('summon-item', `rarity-${item.rarity}`);


		// console.log(`[Debug] Summoned: ${item.name}, Data: ${JSON.stringify(item, null, 2)}`);

        // Determine the image source based on the item type
        let imageUrl = '';
		let imageClass = '';

if (item.type === 'weapon' || (item.type === 'any' && item.video === 'none')) {
    imageUrl = `https://raw.githubusercontent.com/GachaDB/Wuthering-Waves-Assets/refs/heads/main/weapon/${item.image}`;
	imageClass = 'summon-image-weapon';
} else if (item.type === 'resonator' || item.type === 'any') {
    imageUrl = `https://raw.githubusercontent.com/GachaDB/Wuthering-Waves-Assets/refs/heads/main/resonator/Character%20Model/${item.image}`;
	imageClass = 'summon-image-resonator';
}


        // Set the content of the new element with the item's image
        resultContent.innerHTML = `
            <img src="${imageUrl}" alt="${item.name}" class="summon-image ${imageClass}">
        `;

        // Append the new item to the result div
        resultDiv.appendChild(resultContent);
    });
}

	
	function showSummonResult(item, bannerType, pityCount) {
		const summonResultDiv = document.getElementById('summonResult');
		if(!summonResultDiv) {
			// console.error("Error: summonResult div not found in HTML!");
			return;
		}
		let resultMessage = `<p>🎉 You got a <b>5⭐ ${item.name}</b> at <b>${pityCount}</b> pity!</p>`;
		summonResultDiv.innerHTML = resultMessage;
		summonResultDiv.style.display = "block"; // Ensure it's visible
	}
	
	function clearHistory(bannerType) {
		summonData[bannerType] = {
			pity: 0,
			lost50_50: false,
			history: []
		};
		localStorage.setItem('summonData', JSON.stringify(summonData));
		updateHistoryDisplay(bannerType);
		updatePityCounter(bannerType);
	}
	
	function loadHistory() {
		updateHistoryDisplay('hero');
		updateHistoryDisplay('weapon');
		updatePityCounter('hero');
		updatePityCounter('weapon');
	}
	loadHistory();
	</script>
</body>

</html>